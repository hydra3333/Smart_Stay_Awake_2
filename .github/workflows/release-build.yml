# ============================================================================
# GitHub Actions Workflow: Build & Release (Single-File, Self-Contained)
# ============================================================================
#
# GOALS:
#   1) Single-file EXE (self-contained .NET, win-x64)
#   2) Clean Release only (no symbols/docs) + safety guards against strays
#   3) Publish-based packaging (ready-to-run folder) with companions included
#   4) Supply-chain hardening: action pinning (commit SHAs required)
#
# OUTPUT:
#   - ZIP:  Smart_Stay_Awake_2_v{tag}_x64_win10_win11.zip
#   - TXT:  Smart_Stay_Awake_2_v{tag}_x64_win10_win11_SHA256.txt
#
# TRIGGER:
#   - On publishing a GitHub Release (Releases â†’ Draft â†’ Publish)
#
# NOTES:
#   - Self-contained + SingleFile yields a single EXE; we also ship the icon,
#     LICENSE, and any DLL companions emitted by publish.
#   - ReadyToRun is DISABLED (less native clutter; simpler).
#   - Globalization is KEPT (InvariantGlobalization=false).
#   - We DO NOT care about ZIP size; correctness & transparency first.
#
# ============================================================================

name: Build and Release (SingleFile)

on:
  release:
    types: [published]

# Avoid parallel runs for the same tag; cancel older if a new one starts
concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: true

# Needed to upload files to the release
permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest

    defaults:
      run:
        shell: pwsh
        working-directory: src

    steps:
      # ----------------------------------------------------------------------
      # 0) Action pinning â€” IMPORTANT
      # ----------------------------------------------------------------------
      # Replace the placeholders below with the PUBLISHED commit SHAs.
      # You can find the canonical SHAs in each action's GitHub repo under
      # the "Releases" or "Tags" tab. Example format:
      #   uses: actions/checkout@<COMMIT-SHA>  # v4.1.0
      # Until you replace them, the '@vX' tags are left to keep the workflow
      # runnable, but we strongly recommend pinning to SHAs for supply-chain
      # hardening.
      #
      # Example (replace with real SHAs once known):
      #   actions/checkout:         <CHECKOUT_SHA_FOR_v4>
      #   actions/setup-dotnet:     <SETUP_DOTNET_SHA_FOR_v4>
      #   actions/upload-artifact:  <UPLOAD_ARTIFACT_SHA_FOR_v4>
      #   softprops/action-gh-release: <GH_RELEASE_SHA_FOR_v2>

      # ----------------------------------------------------------------------
      # 1) Checkout source
      # ----------------------------------------------------------------------
      - name: ðŸ“¥ Checkout repository
        # uses: actions/checkout@<CHECKOUT_SHA_FOR_v4>  # <- PIN ME
        uses: actions/checkout@v4

      # ----------------------------------------------------------------------
      # 2) Enable long paths (defensive; harmless) + show PS version
      # ----------------------------------------------------------------------
      - name: âš™ï¸ Configure Git for long paths & show PowerShell version
        shell: pwsh
        working-directory: .
        run: |
          $ErrorActionPreference = 'Stop'
          git config --system core.longpaths true
          Write-Host "PowerShell version:" -ForegroundColor Yellow
          $PSVersionTable.PSVersion

      # ----------------------------------------------------------------------
      # 3) Show build context
      # ----------------------------------------------------------------------
      - name: ðŸ” Display build information
        run: |
          $ErrorActionPreference = 'Stop'
          Set-StrictMode -Version Latest
          Write-Host "â•â•â•â•â•â•â•â• BUILD CONTEXT â•â•â•â•â•â•â•â•" -ForegroundColor Cyan
          Write-Host "Tag:        ${{ github.ref_name }}"
          Write-Host "Repository: ${{ github.repository }}"
          Write-Host "Runner:     ${{ runner.os }}"
          Write-Host "Mode:       Publish (Self-Contained, SingleFile, win-x64)"
          Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Cyan

      # ----------------------------------------------------------------------
      # 4) Setup .NET 8 (+ NuGet cache)
      #    We cache both lock files and csproj as a fallback.
      # ----------------------------------------------------------------------
      - name: ðŸ”§ Setup .NET 8 SDK (with NuGet cache)
        # uses: actions/setup-dotnet@<SETUP_DOTNET_SHA_FOR_v4>  # <- PIN ME
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'
          cache: true
          cache-dependency-path: |
            **/packages.lock.json
            **/*.csproj

      # ----------------------------------------------------------------------
      # 5) Verify SDK
      # ----------------------------------------------------------------------
      - name: âœ… Verify .NET installation
        run: |
          $ErrorActionPreference = 'Stop'
          Set-StrictMode -Version Latest
          dotnet --info
          dotnet --list-sdks

      # ----------------------------------------------------------------------
      # 6) Restore packages (solution is at repo root, so use ..\)
      # ----------------------------------------------------------------------
      - name: ðŸ“¦ Restore NuGet packages
        run: |
          $ErrorActionPreference = 'Stop'
          Set-StrictMode -Version Latest
          dotnet restore ..\Smart_Stay_Awake_2.sln --verbosity minimal

      # ----------------------------------------------------------------------
      # 7) Publish (Release, Self-Contained, SingleFile, win-x64)
      #    We explicitly disable symbols/docs for a tight release.
      #    Globalization is kept. ReadyToRun disabled to reduce native clutter.
      #    IncludeNativeLibrariesForSelfExtract=false: avoid temp extraction;
      #    accept a handful of native DLLs next to the EXE if they appear.
      # ----------------------------------------------------------------------
      - name: ðŸ”¨ Publish single-file EXE (Self-Contained, Release, x64)
        run: |
          $ErrorActionPreference = 'Stop'
          Set-StrictMode -Version Latest
          $ProgressPreference = 'SilentlyContinue'

          Write-Host "Publishing Smart_Stay_Awake_2 as SINGLE FILE (self-contained, win-x64)..." -ForegroundColor Yellow

          dotnet publish ..\Smart_Stay_Awake_2.sln `
            -c Release `
            -r win-x64 `
            --self-contained true `
            -p:PublishSingleFile=true `
            -p:PublishReadyToRun=false `
            -p:InvariantGlobalization=false `
            -p:IncludeNativeLibrariesForSelfExtract=false `
            -p:DebugType=None `
            -p:DebugSymbols=false `
            -p:IncludeSymbols=false `
            -p:GenerateDocumentationFile=false `
            -p:ContinuousIntegrationBuild=true `
            --no-restore `
            -v minimal

      # ----------------------------------------------------------------------
      # 8) Locate publish output (TFM can vary; we search for publish folder)
      # ----------------------------------------------------------------------
      - name: ðŸ” Discover publish output folder
        run: |
          $ErrorActionPreference = 'Stop'
          Set-StrictMode -Version Latest

          $publishDir = Get-ChildItem ".\bin\Release\net8.0-windows*\win-x64\publish" -Directory `
                        | Sort-Object LastWriteTime -Descending `
                        | Select-Object -First 1

          if (-not $publishDir) {
            Write-Host "âŒ No publish output under .\bin\Release\net8.0-windows*\win-x64\publish" -ForegroundColor Red
            Get-ChildItem ".\bin\Release" -Recurse -Directory | Select-Object -ExpandProperty FullName
            exit 1
          }

          $BUILD_DIR = $publishDir.FullName
          $TFM_NAME  = ($BUILD_DIR -replace '.*\\bin\\Release\\([^\\]+)\\.*', '$1')

          "BUILD_DIR=$BUILD_DIR" | Out-File -Append -Encoding utf8 $env:GITHUB_ENV
          "TFM_NAME=$TFM_NAME"   | Out-File -Append -Encoding utf8 $env:GITHUB_ENV

          Write-Host "TFM:       $TFM_NAME"
          Write-Host "BUILD_DIR: $BUILD_DIR"

      # ----------------------------------------------------------------------
      # 9) Verify publish output contains the EXE we care about
      # ----------------------------------------------------------------------
      - name: ðŸ” Verify single-file EXE
        run: |
          $ErrorActionPreference = 'Stop'
          Set-StrictMode -Version Latest

          $buildDir = $env:BUILD_DIR
          if (-not (Test-Path $buildDir)) { throw "Publish folder not found: $buildDir" }

          $exePath = Join-Path $buildDir "Smart_Stay_Awake_2.exe"
          if (-not (Test-Path $exePath)) { throw "Executable not found: $exePath" }

          # Surface what else is in publish (there can be support files)
          $files = Get-ChildItem $buildDir -File
          Write-Host "Publish files:" -ForegroundColor Cyan
          $files | ForEach-Object { Write-Host " - $($_.Name)" }

      # ----------------------------------------------------------------------
      # 10) Verify icon + LICENSE (we ship both next to the EXE in ZIP)
      # ----------------------------------------------------------------------
      - name: ðŸ–¼ï¸ Verify icon file
        run: |
          $ErrorActionPreference = 'Stop'
          Set-StrictMode -Version Latest
          $iconPath = ".\Assets\Smart_Stay_Awake_2_icon.png"
          if (-not (Test-Path $iconPath)) { throw "Icon missing: $iconPath" }
          Write-Host "Icon OK: $iconPath"

      - name: ðŸ“œ Verify LICENSE file
        shell: pwsh
        working-directory: .
        run: |
          $ErrorActionPreference = 'Stop'
          Set-StrictMode -Version Latest
          $licenseRoot = "LICENSE"
          if (-not (Test-Path $licenseRoot)) { throw "LICENSE missing at repo root" }
          Copy-Item $licenseRoot (Join-Path "src" "LICENSE") -Force
          Write-Host "LICENSE OK: $licenseRoot"

      # ----------------------------------------------------------------------
      # 11) Stage EXE + icon + LICENSE + ANY companions emitted by publish
      #     We still guard against stray .pdb/.xml (shouldn't exist with flags).
      # ----------------------------------------------------------------------
      - name: ðŸ“ Stage files for packaging (with companions)
        run: |
          $ErrorActionPreference = 'Stop'
          Set-StrictMode -Version Latest

          $staging = ".\release-staging"
          Remove-Item $staging -Recurse -Force -ErrorAction Ignore
          New-Item -ItemType Directory -Force -Path $staging | Out-Null

          # Required trio
          Copy-Item (Join-Path $env:BUILD_DIR "Smart_Stay_Awake_2.exe") (Join-Path $staging "Smart_Stay_Awake_2.exe") -Force
          Copy-Item ".\Assets\Smart_Stay_Awake_2_icon.png" (Join-Path $staging "Smart_Stay_Awake_2_icon.png") -Force
          Copy-Item ".\LICENSE" (Join-Path $staging "LICENSE") -Force

          # Companions (if any) â€” everything else from publish folder EXCEPT the main EXE
          $companions = Get-ChildItem $env:BUILD_DIR -File | Where-Object { $_.Name -ne "Smart_Stay_Awake_2.exe" }
          foreach ($c in $companions) {
            Copy-Item $c.FullName (Join-Path $staging $c.Name) -Force
          }

          # Print staged files + companion summary
          Write-Host "Staged files:" -ForegroundColor Cyan
          Get-ChildItem $staging -File | ForEach-Object { Write-Host " - $($_.Name)" }

          $extra = Get-ChildItem $staging -File | Where-Object { $_.Name -notin @("Smart_Stay_Awake_2.exe","Smart_Stay_Awake_2_icon.png","LICENSE") }
          if ($extra.Count -gt 0) {
            #Write-Host "Companions included:" -ForegroundColor Yellow
            Write-Host "Companions included ($($extra.Count) files):" -ForegroundColor Yellow
            $extra | ForEach-Object { Write-Host "   â€¢ $($_.Name)" -ForegroundColor Yellow }
          } else {
            Write-Host "No companions were emitted by publish (single-file only)." -ForegroundColor Green
          }

          # Guard: no stray .pdb or .xml in staging
          $strays = Get-ChildItem $staging -File | Where-Object { $_.Extension -in @(".pdb",".xml") }
          if ($strays.Count -gt 0) {
            Write-Host "Unexpected debug/docs files found in staging:" -ForegroundColor Red
            $strays | ForEach-Object { Write-Host " - $($_.Name)" -ForegroundColor Red }
            throw "Stray .pdb/.xml files present in staging â€” failing per policy."
          }

          # Final sanity: required trio must exist
          $required = @("Smart_Stay_Awake_2.exe","Smart_Stay_Awake_2_icon.png","LICENSE")
          foreach ($req in $required) {
            if (-not (Test-Path (Join-Path $staging $req))) { throw "Required file missing in staging: $req" }
          }

      # ----------------------------------------------------------------------
      # 12) Create ZIP (versioned by tag) with staged files
      # ----------------------------------------------------------------------
      - name: ðŸ“¦ Create release ZIP
        run: |
          $ErrorActionPreference = 'Stop'
          Set-StrictMode -Version Latest
          $ProgressPreference = 'SilentlyContinue'

          $version     = "${{ github.ref_name }}"
          $zipFileName = "Smart_Stay_Awake_2_${version}_x64_win10_win11.zip"
          Compress-Archive -Path ".\release-staging\*" -DestinationPath $zipFileName -CompressionLevel Optimal -Force
          if (-not (Test-Path $zipFileName)) { throw "ZIP not created: $zipFileName" }
          $sz = (Get-Item $zipFileName).Length
          Write-Host ("ZIP: {0} ({1:N2} MB)" -f $zipFileName, ($sz/1MB))

          "ZIP_PATH=$zipFileName" | Out-File -Append -Encoding utf8 $env:GITHUB_ENV

      # ----------------------------------------------------------------------
      # 13) Verify ZIP contains at least the required trio (EXE, icon, LICENSE)
      # ----------------------------------------------------------------------
      - name: ðŸ” Verify ZIP contents (required trio present)
        run: |
          $ErrorActionPreference = 'Stop'
          Set-StrictMode -Version Latest
          Add-Type -AssemblyName System.IO.Compression.FileSystem

          $zipFileName = $env:ZIP_PATH
          $zip = [System.IO.Compression.ZipFile]::OpenRead($zipFileName)
          $names = ($zip.Entries | ForEach-Object { $_.Name }) | Sort-Object
          $zip.Dispose()

          $required = @('Smart_Stay_Awake_2.exe','Smart_Stay_Awake_2_icon.png','LICENSE')
          foreach ($req in $required) {
            if ($names -notcontains $req) {
              Write-Host "ZIP missing required file: $req" -ForegroundColor Red
              throw "ZIP validation failed."
            }
          }
          Write-Host "ZIP contains required files (EXE, icon, LICENSE)." -ForegroundColor Green

      # ----------------------------------------------------------------------
      # 14) SHA256 checksum (+ verify round-trip)
      # ----------------------------------------------------------------------
      - name: ðŸ” Generate and verify SHA256 checksum
        run: |
          $ErrorActionPreference = 'Stop'
          Set-StrictMode -Version Latest

          $zipFileName = $env:ZIP_PATH
          $shaFile     = "$zipFileName`_SHA256.txt"

          $hash = Get-FileHash -Path $zipFileName -Algorithm SHA256
          ($hash.Hash.ToLower() + "  " + $zipFileName) | Out-File $shaFile -Encoding ASCII -NoNewline

          # Verify
          $expected = (Get-Content $shaFile -Raw).Split([char]32)[0].Trim()
          $actual   = (Get-FileHash -Path $zipFileName -Algorithm SHA256).Hash.ToLower()
          if ($expected -ne $actual) { throw "Checksum mismatch: expected $expected, actual $actual" }
          Write-Host "Checksum verified."

          "SHA_PATH=$shaFile" | Out-File -Append -Encoding utf8 $env:GITHUB_ENV

      # ----------------------------------------------------------------------
      # 15) Upload as workflow artifacts (debug/fallback)
      # ----------------------------------------------------------------------
      - name: â¬†ï¸ Upload artifacts (debug)
        # uses: actions/upload-artifact@<UPLOAD_ARTIFACT_SHA_FOR_v4>  # <- PIN ME
        uses: actions/upload-artifact@v4
        with:
          name: ssa2-${{ github.ref_name }}
          path: |
            src/${{ env.ZIP_PATH }}
            src/${{ env.SHA_PATH }}
          if-no-files-found: error
          retention-days: 90

      # ----------------------------------------------------------------------
      # 16) Upload to the GitHub Release (public)
      # ----------------------------------------------------------------------
      - name: ðŸš€ Upload release assets
        # uses: softprops/action-gh-release@<GH_RELEASE_SHA_FOR_v2>  # <- PIN ME
        uses: softprops/action-gh-release@v2
        with:
          files: |
            src/${{ env.ZIP_PATH }}
            src/${{ env.SHA_PATH }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ----------------------------------------------------------------------
      # 17) Build summary
      # ----------------------------------------------------------------------
      - name: ðŸ“Š Build summary
        run: |
          $ErrorActionPreference = 'Stop'
          Set-StrictMode -Version Latest
          $version = "${{ github.ref_name }}"
          $zip     = $env:ZIP_PATH
          $sizeMB  = "{0:N2}" -f ((Get-Item $zip).Length/1MB)

          # Did we include companions?
          $staging = ".\release-staging"
          $extra = Get-ChildItem $staging -File | Where-Object { $_.Name -notin @("Smart_Stay_Awake_2.exe","Smart_Stay_Awake_2_icon.png","LICENSE") }
          # Build companion summary with count
          $companionSummary = if ($extra.Count -gt 0) {
              "$($extra.Count) file(s): $($extra.Name -join ', ')"
          } else {
              "none"
          }

          Write-Host "â•â•â•â•â•â•â•â• BUILD COMPLETE âœ… â•â•â•â•â•â•â•â•" -ForegroundColor Green
          Write-Host "Version:   $version"
          Write-Host "TFM:       $env:TFM_NAME"
          Write-Host "Target:    win-x64"
          Write-Host "Mode:      Self-Contained + SingleFile"
          Write-Host "ZIP:       $zip ($sizeMB MB)"
          Write-Host "License:   LICENSE included"
          Write-Host "Companions: $companionSummary"
          Write-Host "Release:   https://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name }}"
          Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Green
